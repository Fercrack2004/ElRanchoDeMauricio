<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElRanchoDeMauricio | <%= @blog.title %></title>
  
  <!-- Precarga de fuentes WOFF2 -->
  <link rel="preload" href="https://fonts.gstatic.com/s/dancingscript/v24/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup5.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/playfairdisplay/v30/nuFvD-vYSZviVYUb_rj3ij__anPXJzDwcbmjWBN2PKdFvXDXbtY.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/opensans/v29/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4gaVc.woff2" as="font" type="font/woff2" crossorigin>

  <!-- Preload de estilos importantes -->
  <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload", as: "style", onload: "this.onload=null;this.rel='stylesheet'" %>
  <noscript><%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %></noscript>
  
  <!-- Estilos críticos inline optimizados -->
  <style>
    /* Fuente de respaldo optimizada */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-image: url('https://www.transparenttextures.com/patterns/cream-pixels.png');
      background-color: #f8f8f8;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Estilos para cuando las fuentes cargan */
    .fonts-loaded body {
      font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    
    .fonts-loaded .font-cursive {
      font-family: 'Dancing Script', cursive;
    }
    
    .fonts-loaded .font-serif {
      font-family: 'Playfair Display', serif;
    }
    
    /* ESTILOS ESPECÍFICOS PARA LA BARRA DE NAVEGACIÓN */
    .navbar-brand {
      font-weight: bold;
      display: flex;
      align-items: center;
    }
    
    /* Fuente temporal para evitar FOUT - lo más similar posible */
    .navbar-brand .logo-part {
      font-family: 'Comic Sans MS', 'Apple Chancery', cursive;
      font-size: 1.875rem; /* 30px */
      line-height: 1;
    }
    
    .navbar-brand .logo-connector {
      font-family: Georgia, 'Times New Roman', serif;
      font-style: italic;
      color: #fbbf24; /* text-accent-400 */
      font-size: 1.25rem; /* 20px */
      margin: 0 0.25rem;
      line-height: 1;
    }
    
    /* Cuando cargan las fuentes reales */
    .fonts-loaded .navbar-brand .logo-part {
      font-family: 'Dancing Script', cursive;
      visibility: visible;
    }
    
    .fonts-loaded .navbar-brand .logo-connector {
      font-family: 'Playfair Display', serif;
      visibility: visible;
    }
    
    /* Ocultar inicialmente para evitar FOUT */
    .navbar-brand .logo-part,
    .navbar-brand .logo-connector {
      visibility: hidden;
    }
    
    /* Estilos mínimos para Tailwind antes de cargar */
    .bg-primary-gradient {
      background: linear-gradient(to right, #991b1b, #b91c1c);
    }
    
    .bg-secondary-800 {
      background-color: #166534;
    }
    
    .text-accent-400 {
      color: #fbbf24;
    }
    
    .turbo-progress-bar {
      height: 5px;
      background-color: #ef4444;
    }
  </style>

  <!-- CDN de Tailwind con integración Turbo optimizada -->
  <script>
    // Función para cargar Tailwind
    function loadTailwind() {
      if (!window.tailwindLoaded) {
        var tailwindScript = document.createElement('script');
        tailwindScript.src = 'https://cdn.tailwindcss.com';
        tailwindScript.onload = function() {
          tailwind.config = {
            theme: {
              extend: {
                colors: {
                  primary: {
                    800: '#991b1b',
                    700: '#b91c1c',
                    600: '#dc2626',
                    DEFAULT: '#ef4444',
                    400: '#f87171',
                    300: '#fca5a5',
                    50: '#fef2f2'
                  },
                  secondary: {
                    800: '#166534',
                    700: '#15803d',
                    600: '#16a34a',
                    DEFAULT: '#22c55e',
                    400: '#4ade80',
                    300: '#86efac',
                    50: '#f0fdf4'
                  },
                  accent: {
                    DEFAULT: '#f59e0b',
                    600: '#d97706',
                    400: '#fbbf24'
                  }
                },
                fontFamily: {
                  'cursive': ['"Dancing Script"', 'cursive'],
                  'sans': ['"Open Sans"', 'sans-serif'],
                  'serif': ['"Playfair Display"', 'serif']
                },
                backgroundImage: {
                  'hero-pattern': "url('https://images.unsplash.com/photo-1543351611-58f69d7c1781?q=80&w=2070&auto=format&fit=crop')",
                  'texture': "url('https://www.transparenttextures.com/patterns/cream-pixels.png')"
                }
              }
            }
          };
          window.tailwindLoaded = true;
        };
        document.head.appendChild(tailwindScript);
      }
    }

    // Función para cargar fuentes
    function loadFonts() {
      var fontLink = document.createElement('link');
      fontLink.href = 'https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Open+Sans:wght@400;700&family=Playfair+Display:wght@700&display=swap';
      fontLink.rel = 'stylesheet';
      document.head.appendChild(fontLink);
      
      // Función para verificar fuentes
      function checkFonts() {
        if (document.fonts) {
          Promise.all([
            document.fonts.load('1em Dancing Script'),
            document.fonts.load('1em Playfair Display')
          ]).then(function() {
            document.documentElement.classList.add('fonts-loaded');
          });
        } else {
          setTimeout(function() {
            document.documentElement.classList.add('fonts-loaded');
          }, 300);
        }
      }
      
      // Verificar fuentes periódicamente
      checkFonts();
      setTimeout(checkFonts, 500);
      setTimeout(checkFonts, 1000);
    }
    
    // Cargar recursos cuando la página esté interactiva
    document.addEventListener('DOMContentLoaded', function() {
      if (window.requestIdleCallback) {
        requestIdleCallback(loadTailwind);
        requestIdleCallback(loadFonts);
      } else {
        setTimeout(loadTailwind, 0);
        setTimeout(loadFonts, 0);
      }
    });
    
    // Manejar eventos de Turbo
    document.addEventListener('turbo:load', function() {
      if (!window.tailwindLoaded) {
        loadTailwind();
      }
      loadFonts();
    });
  </script>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Barra de navegación optimizada -->
  <nav class="bg-primary-gradient text-white shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center py-3">
        <div class="flex items-center space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          <a href="/" data-turbo="false" class="navbar-brand hover:text-primary-300 transition-colors duration-300">
            <span class="logo-part">ElRancho</span>
            <span class="logo-connector">de</span>
            <span class="logo-part">Mauricio</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- Botón de volver -->
    <div class="mb-8">
      <%= link_to blogs_path, class: "inline-flex items-center group text-primary-600 hover:text-primary-800 transition-colors duration-200", data: { turbo: false } do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span class="text-lg font-medium">Volver a Blogs</span>
      <% end %>
    </div>

    <!-- Tarjeta del blog -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 mb-8">
      <!-- Imagen -->
      <div class="relative h-96 w-full overflow-hidden">
        <img src="https://source.unsplash.com/random/1200x600/?food,<%= @blog.title.parameterize %>" 
             alt="<%= @blog.title %>" 
             class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" 
             loading="lazy" />
        <div class="absolute inset-0 bg-gradient-to-t from-white/30 to-transparent"></div>
      </div>

      <!-- Contenido -->
      <div class="p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 mb-4"><%= @blog.title %></h1>
        
        <div class="prose max-w-none text-gray-800 mb-6">
          <%= simple_format(@blog.description, {}, wrapper_tag: "div") %>
        </div>

        <!-- Metadatos -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-6">
          <span class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Publicado el <%= @blog.created_at.strftime("%d/%m/%Y") %>
          </span>
          <span class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <% if @blog.cook_time && @blog.cook_time > 0 %>
              Tiempo de preparación: <%= @blog.cook_time %> min
            <% else %>
              Tiempo no especificado
            <% end %>
          </span>
          <span class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
            4.8 (24 reseñas)
          </span>
        </div>

        <!-- Acciones -->
        <div class="flex flex-wrap gap-4 border-t border-gray-100 pt-6">
          <%= link_to "Ver Reviews", blog_reviews_path(@blog), 
              class: "flex items-center px-5 py-2.5 bg-white border border-primary-600 text-primary-600 hover:bg-primary-50 rounded-lg font-medium shadow-sm transition-colors duration-200", 
              data: { turbo: false } %>

          <%= link_to "Dejar Review", new_blog_review_path(@blog), 
              class: "flex items-center px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200", 
              data: { turbo: false } %>

          <% participation = @blog.blog_participations.find_by(user: current_user) %>
          <% if current_user && (participation&.autor_contribution? || current_user.admin? || current_user.moderator?) %>
            <%= link_to "Ver Solicitudes", blog_requests_path(@blog), 
                class: "flex items-center px-5 py-2.5 bg-accent-600 hover:bg-accent-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200", 
                data: { turbo: false } %>
          <% end %>

          <% if !participation&.autor_contribution? && !participation&.editor_contribution? %>
            <%= link_to "Solicitar Editar", new_blog_request_path(@blog), 
                class: "flex items-center px-5 py-2.5 bg-accent-600 hover:bg-accent-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200", 
                data: { turbo: false } %>
          <% end %>

          <% if @blog.chat_room.present? %>
            <% if participation&.autor_contribution? || participation&.editor_contribution? %>
              <%= link_to "Chatroom Editores", blog_chat_room_path(@blog, @blog.chat_room), 
                  class: "flex items-center px-5 py-2.5 bg-secondary-600 hover:bg-secondary-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200", 
                  data: { turbo: false } %>
            <% end %>
          <% end %>

          <% if participation&.autor_contribution? || participation&.editor_contribution? %>
            <%= link_to "Editar Blog", edit_blog_path(@blog), 
                class: "flex items-center px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200", 
                data: { turbo: false } %>
          <% end %>

          <!-- Botón para borrar el blog (solo visible para admin) -->
          <% if current_user&.admin? %>
            <%= button_to "Eliminar Blog", blog_path(@blog), 
                method: :delete, 
                form: { 
                  data: { 
                    turbo: "false",  # ← Esto desactiva Turbo para este formulario
                    turbo_confirm: "¿Estás seguro de que quieres eliminar este blog? Esta acción no se puede deshacer."
                  } 
                },
                class: "flex items-center px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200" %>
          <% end %>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-secondary-800 text-white pt-12 pb-6">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <p class="text-sm mb-4 md:mb-0">&copy; <%= Time.current.year %> ElRanchoDeMauricio. Todos los derechos reservados.</p>
        <div class="flex space-x-6">
          <a href="#" class="text-white/60 hover:text-white transition-colors">Política de Privacidad</a>
          <a href="#" class="text-white/60 hover:text-white transition-colors">Términos</a>
          <a href="#" class="text-white/60 hover:text-white transition-colors">Contacto</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Script final para manejar fuentes -->
  <script>
    // Verificación final de fuentes cargadas
    function checkFontsLoaded() {
      if (document.fonts) {
        Promise.all([
          document.fonts.load('1em Dancing Script'),
          document.fonts.load('1em Playfair Display')
        ]).then(function() {
          if (!document.documentElement.classList.contains('fonts-loaded')) {
            document.documentElement.classList.add('fonts-loaded');
          }
        });
      } else {
        document.documentElement.classList.add('fonts-loaded');
      }
    }

    // Verificar periódicamente por si falla la primera carga
    document.addEventListener('DOMContentLoaded', function() {
      checkFontsLoaded();
      setTimeout(checkFontsLoaded, 500);
    });
    
    document.addEventListener('turbo:load', function() {
      checkFontsLoaded();
      setTimeout(checkFontsLoaded, 500);
    });
  </script>
</body>
</html>